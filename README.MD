# üö™ Projeto de Monitoramento de Port√µes de Emerg√™ncia

![Aplicativo Monitoramento](https://github.com/oondels/emergency-gate-monitoring/blob/main/images/emergency_gate_front.jpg?raw=true)
![Aplicativo Monitoramento Abertura](https://github.com/oondels/emergency-gate-monitoring/blob/main/images/emergency_gate_openings.jpg?raw=true)
![Aplicativo Monitoramento Sem sinal](https://github.com/oondels/emergency-gate-monitoring/blob/main/images/emergency_gate_no-signal.jpg?raw=true)

## üìã Descri√ß√£o

Sistema completo de monitoramento em tempo real para port√µes de emerg√™ncia, composto por dispositivos IoT (ESP32), servidor backend Node.js e aplica√ß√£o web Vue.js. O sistema registra aberturas, mant√©m hist√≥rico no banco de dados PostgreSQL, notifica usu√°rios via e-mail e exibe atualiza√ß√µes em tempo real atrav√©s de WebSockets.

O projeto garante seguran√ßa e compliance ao fornecer monitoramento cont√≠nuo, alertas autom√°ticos e relat√≥rios detalhados sobre o uso dos port√µes de emerg√™ncia.

## ‚ú® Funcionalidades Principais

- **Monitoramento em Tempo Real**: Comunica√ß√£o bidirecional via Socket.IO entre dispositivos e aplica√ß√£o web
- **Sistema de Heartbeat**: Detec√ß√£o autom√°tica de dispositivos offline/online
- **Modo Offline**: Armazenamento local de eventos quando sem conex√£o, com sincroniza√ß√£o autom√°tica
- **Alertas Inteligentes**: 
  - Alarme sonoro na aplica√ß√£o web
  - Sirene f√≠sica no dispositivo
  - Notifica√ß√µes por e-mail
- **Hist√≥rico Completo**: Registro de todas as aberturas com timestamp
- **Interface Responsiva**: Dashboard adapt√°vel para desktop e mobile
- **Multi-Port√£o**: Suporte para m√∫ltiplos port√µes simultaneamente
- **Status Visual**: Indicadores de estado (aberto/fechado/desconectado)

## üèóÔ∏è Arquitetura do Sistema

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Dispositivo    ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   Servidor       ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   Front-end     ‚îÇ
‚îÇ  ESP32          ‚îÇ         ‚îÇ   Node.js        ‚îÇ         ‚îÇ   Vue.js        ‚îÇ
‚îÇ                 ‚îÇ         ‚îÇ                  ‚îÇ         ‚îÇ                 ‚îÇ
‚îÇ ‚Ä¢ Sensor        ‚îÇ         ‚îÇ ‚Ä¢ Socket.IO      ‚îÇ         ‚îÇ ‚Ä¢ Dashboard     ‚îÇ
‚îÇ ‚Ä¢ RTC DS3231    ‚îÇ         ‚îÇ ‚Ä¢ Express        ‚îÇ         ‚îÇ ‚Ä¢ Vuetify       ‚îÇ
‚îÇ ‚Ä¢ WiFi          ‚îÇ         ‚îÇ ‚Ä¢ PostgreSQL     ‚îÇ         ‚îÇ ‚Ä¢ Socket.IO     ‚îÇ
‚îÇ ‚Ä¢ Sirene        ‚îÇ         ‚îÇ ‚Ä¢ NodeMailer     ‚îÇ         ‚îÇ ‚Ä¢ Alertas       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                            ‚îÇ                            ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         Socket.IO + HTTP
```

## üîß Componentes do Sistema

### Hardware (Dispositivo ESP32)

- **Microcontrolador**: ESP32 DevKit
- **RTC**: M√≥dulo DS3231 (clock em tempo real)
- **Sensor**: Rel√©/Switch de porta (GPIO16)
- **Sirene**: Buzzer/Sirene (GPIO17)
- **Comunica√ß√£o**: WiFi 2.4GHz
- **Protocolo**: Socket.IO (Engine.IO v4) + HTTP

### Software Backend (Servidor Node.js)

- **Runtime**: Node.js
- **Framework**: Express.js
- **WebSocket**: Socket.IO
- **Banco de Dados**: PostgreSQL
- **E-mail**: NodeMailer (SMTP Gmail)
- **Porta**: 3028

### Software Frontend (Aplica√ß√£o Vue.js)

- **Framework**: Vue.js 3 (Composition API)
- **UI Library**: Vuetify 3
- **Cliente WebSocket**: Socket.IO Client
- **Estilo**: CSS3 com anima√ß√µes
- **Recursos**: Alertas sonoros, indicadores visuais

## üì¶ Estrutura do Projeto

```
emergency-gate-monitoring/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ main.cpp              # Firmware ESP32 (PlatformIO)
‚îú‚îÄ‚îÄ test/
‚îÇ   ‚îî‚îÄ‚îÄ doorRepository.js     # Reposit√≥rio de dados (PostgreSQL)
‚îú‚îÄ‚îÄ platformio.ini            # Configura√ß√µes PlatformIO
‚îú‚îÄ‚îÄ images/                   # Screenshots da aplica√ß√£o
‚îî‚îÄ‚îÄ README.MD

Arquivos Relacionados (Reposit√≥rios Externos):
‚îú‚îÄ‚îÄ portao_emerg.js          # Servidor Socket.IO/Express
‚îú‚îÄ‚îÄ PortaoEmergencia.vue     # Componente Vue.js Frontend
‚îî‚îÄ‚îÄ mailer.js                # Configura√ß√£o de e-mail
```

## üöÄ Instala√ß√£o e Configura√ß√£o

### 1Ô∏è‚É£ Banco de Dados PostgreSQL

```sql
-- Criar schema
CREATE SCHEMA IF NOT EXISTS portoes;

-- Tabela de port√µes registrados
CREATE TABLE portoes.portoes_emerg_registrados (
    door_id VARCHAR(10) PRIMARY KEY,
    name VARCHAR(100) NOT NULL
);

-- Tabela de eventos/hist√≥rico
CREATE TABLE portoes.portoes_emergencia (
    id SERIAL PRIMARY KEY,
    portao VARCHAR(10) REFERENCES portoes.portoes_emerg_registrados(door_id),
    status BOOLEAN NOT NULL,
    date TIMESTAMP NOT NULL DEFAULT NOW()
);

-- √çndices para performance
CREATE INDEX idx_portoes_date ON portoes.portoes_emergencia(date DESC);
CREATE INDEX idx_portoes_status ON portoes.portoes_emergencia(portao, status);
```

### 2Ô∏è‚É£ Servidor Backend (Node.js)

```bash
# Instalar depend√™ncias
npm install express socket.io cors pg nodemailer

# Criar arquivo .env
cat > .env << EOF
# Banco de Dados PostgreSQL
IP=localhost
PORT=5432
USERS=postgres
PASS=sua_senha
DBASE=nome_database

# Configura√ß√£o de E-mail
EMAIL=seu_email@gmail.com
EMAIL_PASS=senha_app_gmail
EOF

# Iniciar servidor
node portao_emerg.js
```

**Depend√™ncias principais:**
- `express`: ^4.18.0
- `socket.io`: ^4.6.0
- `pg`: ^8.11.0
- `nodemailer`: ^6.9.0
- `cors`: ^2.8.5

### 3Ô∏è‚É£ Dispositivo ESP32 (Firmware)

**Usando PlatformIO:**

```bash
# Instalar PlatformIO CLI
pip install platformio

# Navegar at√© o diret√≥rio do projeto
cd emergency-gate-monitoring

# Compilar
pio run

# Fazer upload para ESP32
pio run --target upload

# Monitorar Serial
pio device monitor -b 115200
```

**Configura√ß√µes no `src/main.cpp`:**

```cpp
// WiFi
const char *ssid = "SUA_REDE_WIFI";
const char *password = "SUA_SENHA_WIFI";

// Servidor
#define URL_LINK "http://IP_SERVIDOR:3028/portao_emerg"
const char *websockets_server = "IP_SERVIDOR";
const uint16_t websockets_server_port = 3028;

// Identifica√ß√£o do Port√£o
const char *door_id = "1";  // ID √∫nico do port√£o
const char *name = "Port√£o Emerg√™ncia 1";  // Nome descritivo
```

**Bibliotecas necess√°rias** (gerenciadas pelo PlatformIO):
- `ArduinoJson` (^7.4.2)
- `RTClib` (^2.1.4)
- `WebSockets` (^2.3.0)
- `ArduinoHttpClient` (^0.6.1)

### 4Ô∏è‚É£ Frontend (Vue.js)

```bash
# Em um projeto Vue.js existente, instalar depend√™ncias
npm install socket.io-client

# Configurar IP do servidor em @/ip.js
echo "export default 'IP_SERVIDOR'" > src/ip.js

# Copiar componente PortaoEmergencia.vue para src/views/
# Adicionar rota no router
```

**Configura√ß√£o de rota (router/index.js):**

```javascript
{
  path: '/portoes-emergencia',
  name: 'PortaoEmergencia',
  component: () => import('@/views/PortaoEmergencia.vue')
}
```

## üîå Conex√µes do Hardware

### Pinagem ESP32

| Componente | Pino ESP32 | GPIO | Fun√ß√£o |
|------------|-----------|------|--------|
| Sensor/Rel√© | 16 | GPIO16 | INPUT_PULLUP |
| Sirene | 17 | GPIO17 | OUTPUT |
| RTC SDA | 21 | GPIO21 | I2C Data |
| RTC SCL | 22 | GPIO22 | I2C Clock |
| RTC VCC | 3.3V | - | Alimenta√ß√£o |
| RTC GND | GND | - | Terra |

### Diagrama de Conex√£o

```
         ESP32                    RTC DS3231
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ             ‚îÇ          ‚îÇ              ‚îÇ
    ‚îÇ  GPIO21 ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ SDA          ‚îÇ
    ‚îÇ  GPIO22 ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ SCL          ‚îÇ
    ‚îÇ  3.3V   ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ VCC          ‚îÇ
    ‚îÇ  GND    ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ GND          ‚îÇ
    ‚îÇ             ‚îÇ          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ  GPIO16 ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ Sensor de Porta
    ‚îÇ  GPIO17 ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ Sirene
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üì° Protocolo de Comunica√ß√£o

### Eventos Socket.IO (Dispositivo ‚Üí Servidor)

| Evento | Dire√ß√£o | Payload | Descri√ß√£o |
|--------|---------|---------|-----------|
| `conclude_connection` | ESP32‚ÜíServer | `{door, name, status}` | Handshake inicial |
| `heartbeat` | ESP32‚ÜíServer | `{door_id: timestamp}` | Keep-alive (5s) |
| `door_status` | ESP32‚ÜíServer | `{door, status}` | Resposta de status |

### Eventos Socket.IO (Servidor ‚Üí Dispositivo)

| Evento | Dire√ß√£o | Payload | Descri√ß√£o |
|--------|---------|---------|-----------|
| `start_conclude_connection` | Server‚ÜíESP32 | - | Inicia handshake |
| `get_door_status` | Server‚ÜíESP32 | `{door}` | Requisita status |
| `conclude_ack` | Server‚ÜíESP32 | `{door}` | Confirma conex√£o |

### Eventos Socket.IO (Aplica√ß√£o Web)

| Evento | Dire√ß√£o | Payload | Descri√ß√£o |
|--------|---------|---------|-----------|
| `get_all_doors` | Client‚ÜíServer | - | Lista todos port√µes |
| `get_connected_doors` | Client‚ÜíServer | - | Lista port√µes online |
| `last_openings` | Client‚ÜíServer | `{door, limit}` | Hist√≥rico |
| `portao_emerg` | Server‚ÜíClient | `{door, status, date}` | Atualiza√ß√£o em tempo real |
| `door_connected` | Server‚ÜíClient | `{door, name, status}` | Novo port√£o online |
| `door_disconnect` | Server‚ÜíClient | `{door, alive, timestamp}` | Port√£o offline |

### Endpoint HTTP

```
POST /portao_emerg
Content-Type: application/json

{
  "open": true,
  "door": "1",
  "offline_mode": false,
  "offline_openings": ["dd/MM/yyyy HH:mm:ss", ...]
}
```

## üîç Funcionalidades Detalhadas

### Sistema de Heartbeat

**Dispositivo ESP32:**
- Envia heartbeat a cada 5 segundos
- TTL: 10 segundos (2x intervalo)
- Marca automaticamente como offline se n√£o responder

**Aplica√ß√£o Web:**
- Envia heartbeat a cada 15 segundos
- Verifica conex√£o do servidor
- Exibe aviso se desconectado

### Modo Offline (ESP32)

Quando sem conex√£o WiFi ou servidor inacess√≠vel:
1. Eventos s√£o armazenados em buffer local (20 posi√ß√µes)
2. Timestamp obtido do RTC DS3231
3. Ao reconectar, sincroniza automaticamente via HTTP POST
4. Buffer √© limpo ap√≥s envio bem-sucedido

### Alertas e Notifica√ß√µes

**Quando port√£o abre:**
1. ‚úÖ ESP32 aciona sirene f√≠sica
2. ‚úÖ Servidor registra no banco de dados
3. ‚úÖ Servidor envia evento Socket.IO
4. ‚úÖ Aplica√ß√£o web toca alarme sonoro
5. ‚úÖ Servidor envia e-mail (opcional/comentado)

**Quando port√£o fecha:**
1. ‚úÖ ESP32 desliga sirene
2. ‚úÖ Servidor registra fechamento
3. ‚úÖ Aplica√ß√£o atualiza status visual

## üé® Interface do Usu√°rio

### Tela Inicial
- Bot√£o para iniciar monitoramento
- Conecta ao servidor Socket.IO

### Dashboard de Monitoramento
- **Cards de Port√£o**: Um para cada port√£o registrado
  - Cor verde: Fechado
  - Cor vermelha (pulsante): Aberto
  - Cor cinza: Desconectado
- **Informa√ß√µes por card**:
  - Nome do port√£o
  - Status atual
  - √öltima atualiza√ß√£o
  - √öltimas 5 aberturas (expand√≠vel)
  - √çcone de conex√£o

### Estados Visuais
```css
.door-card.open      ‚Üí Vermelho + anima√ß√£o pulse
.door-card.close     ‚Üí Verde
.door-card.disconnected ‚Üí Cinza + borda tracejada
```

## üõ°Ô∏è Seguran√ßa e Confiabilidade

- ‚úÖ Reconex√£o autom√°tica de WebSocket
- ‚úÖ Detec√ß√£o de dispositivos offline
- ‚úÖ Buffer de eventos offline
- ‚úÖ Valida√ß√£o de IDs de port√£o
- ‚úÖ Debounce de sensor (50ms)
- ‚úÖ Timestamp sincronizado (RTC)
- ‚úÖ Tratamento de erros HTTP/Socket
- ‚úÖ Pooling de conex√µes PostgreSQL

## üìä Monitoramento e Logs

### Logs do Servidor
```
[Sistema] Porta conectada: Port√£o 1
[WS] Heartbeat check - doors connected: 3
[HTTP] Dados recebidos do port√£o: {door: "1", status: true}
[WS] Porta desconectada: Port√£o 2
```

### Logs do Dispositivo
```
[WiFi] Conectado com sucesso
[WS] Conectado
[WS] conclude_connection enviado
[Porta] Aberta, enviando
[WS] Heartbeat enviado
```

## üêõ Troubleshooting

### Dispositivo n√£o conecta

```bash
# Verificar WiFi
# No Serial Monitor, verificar se conectou com sucesso

# Verificar servidor
curl http://IP_SERVIDOR:3028/

# Verificar firewall
sudo ufw allow 3028
```

### Aplica√ß√£o n√£o recebe atualiza√ß√µes

```javascript
// Verificar IP do servidor em @/ip.js
// Conferir porta 3028 acess√≠vel
// Verificar console do navegador para erros Socket.IO
```

### Banco de dados n√£o registra

```sql
-- Verificar conex√£o
SELECT * FROM portoes.portoes_emerg_registrados;

-- Verificar √∫ltimos eventos
SELECT * FROM portoes.portoes_emergencia ORDER BY date DESC LIMIT 10;
```

## üîÑ Fluxo de Funcionamento

```mermaid
sequenceDiagram
    participant E as ESP32
    participant S as Servidor
    participant D as Database
    participant W as Web App
    
    E->>S: conclude_connection
    S->>D: INSERT door (se novo)
    S->>W: door_connected
    
    loop Heartbeat
        E->>S: heartbeat (5s)
        W->>S: heartbeat (15s)
    end
    
    E->>S: Sensor detecta abertura
    S->>D: INSERT event (status=true)
    S->>W: portao_emerg event
    W->>W: Toca alarme
    S->>S: Envia e-mail (opcional)
    
    E->>S: Sensor detecta fechamento
    S->>D: INSERT event (status=false)
    S->>W: Atualiza√ß√£o status
```

## üìà Melhorias Futuras

- [ ] Dashboard de estat√≠sticas e gr√°ficos
- [ ] Exporta√ß√£o de relat√≥rios (PDF/Excel)
- [ ] Autentica√ß√£o de usu√°rios
- [ ] Configura√ß√£o de alertas personalizados
- [ ] Suporte MQTT como alternativa
- [ ] App mobile nativo
- [ ] Integra√ß√£o com sistemas de seguran√ßa
- [ ] Backup autom√°tico de dados


## üë• Contribuidores

Desenvolvido para sistema de monitoramento de seguran√ßa empresarial.

---

**Status do Projeto**: ‚úÖ Em Produ√ß√£o  
**√öltima Atualiza√ß√£o**: Novembro 2025
